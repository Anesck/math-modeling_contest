## 层次分析法（Analytic Hierarchy Process，AHP）

层次分析法(AHP)是美国运筹学家匹茨堡大学教授萨蒂(T.L.Saaty)于上世纪70年代初，为美国国防部研究“根据各个工业部门对国家福利的贡献大小而进行电力分配”课题时，应用网络系统理论和多目标综合评价方法，提出的一种层次权重决策分析方法。

**特点：**在对复杂的决策问题的本质、影响因素及其内在关系等进行深入分析的基础上，利用较少的定量信息使决策的思维过程数学化，从而为多目标、多准则或无结构特性的复杂决策问题提供简便的决策方法。

**基本原理：**层次分析法根据问题的性质和要达到的总目标，将问题分解为不同的组成因素,并按照因素间的相互关联影响以及隶属关系将因素按不同层次聚集组合，形成一个多层次的分析结构模型，从而最终使问题归结为最低层（供决策的方案、措施等）相对于最高层（总目标）的相对重要权值的确定或相对优劣次序的排定。

运用层次分析法构造系统模型时，可分为以下四个步骤，并以决策问题：“在苏杭、北戴河、桂林三处选择一个旅游点。要考虑景点的景色、居住的环境、饮食的特色、交通便利和旅游的费用。”作为案例：

### 一、建立层次结构模型：

   1. 将决策的目标、考虑的因素（决策准则）和决策对象按它们之间的相互关系分为最高层、中间层和最低层，绘出层次结构图。

   2. 最高层：决策的目的、要解决的问题。

   3. 最低层：决策时的备选方案。

   4. 中间层：考虑的因素、决策的准则。

案例中的层次结构模型示例：

   ```mermaid
   graph BT
   subgraph <h1>
   obj[最高层<br><br> <目标层> <br>]
   Z[Z<br><br> <选择旅游地> <br>]
   end
   subgraph <h2>
   rule[中间层<br><br> <准则层> <br>]
   A1[A1<br><br> <景色> <br>]
   A2[A2<br><br> <费用> <br>]
   A3[A3<br><br> <居住> <br>]
   A4[A4<br><br> <饮食> <br>]
   A5[A5<br><br> <旅途> <br>]
   end
   subgraph <h3>
   plan[最低层<br><br> <方案层> <br>]
   B1[B1<br><br> <苏杭> <br>]
   B2[B2<br><br> <北戴河> <br>]
   B3[B3<br><br> <桂林> <br>]
   end
   plan --> rule --> obj
   B1 & B2 & B3 --> A1
   B1 & B2 & B3 --> A2
   B1 & B2 & B3 --> A3
   B1 & B2 & B3 --> A4
   B1 & B2 & B3 --> A5
   A1 & A2 & A3 & A4 & A5--> Z
   ```

### 二、构造判断(成对比较)矩阵：在确定各层次各因素之间的权重时，如果只是定性的结果，则常常不容易被别人接受，因而 Saaty 等人提出 —— 一致矩阵法：

   1. 不把所有因素放在一起比较，而是两两相互比较。

   2. 对此时采用相对尺度，以尽可能减少性质不同的诸因素相互比较的困难，以提高准确度。

   3. 由上两点可以构造成对比较矩阵，成对比较矩阵是表示本层所有因素针对上一层某一个因素的相对重要性的比较。成对比较矩阵矩阵的元素 $a_{ij}$ 用 Saaty 的 1—9 标度方法给出：

      |    标度    |                             含义                             |
      | :--------: | :----------------------------------------------------------: |
      |     1      |               表示两个因素相比,具有同样重要性                |
      |     3      |        表示两个因素相比，一个因素比另一个因素稍微重要        |
      |     5      |        表示两个因素相比，一个因素比另一个因素明显重要        |
      |     7      |        表示两个因素相比，一个因素比另一个因素强烈重要        |
      |     9      |        表示两个因素相比，一个因素比另一个因素极端重要        |
      | 2, 4, 6, 8 |                     上述两相邻判断的中值                     |
      |    倒数    | 因素 $i$ 与 $j$ 比较的判断 $a_{ij}$ ，则因素 $j$ 与 $i$ 比较的判断 $a_{ij}=1/a_{ji}$ |

      案例中准则层的所有因素（A1 ~ A5）对目标层因素 Z 的成对比较矩阵示例：

      |   因素    |  A1  |  A2  |  A3  |  A4  |  A5  |
      | :-------: | :--: | :--: | :--: | :--: | :--: |
      | <b>A1</b> |  1   | 1/2  |  4   |  3   |  3   |
      | <b>A2</b> |  2   |  1   |  7   |  5   |  5   |
      | <b>A3</b> | 1/4  | 1/7  |  1   | 1/2  | 1/3  |
      | <b>A4</b> | 1/3  | 1/5  |  2   |  1   |  1   |
      | <b>A5</b> | 1/3  | 1/5  |  3   |  1   |  1   |

      根据上表可得到成对比较矩阵：
      $$
      \large
      A = \left[
      	\matrix{
         	1 & \frac{1}{2} & 4 & 3 & 3\\
         	2 & 1 & 7 & 5 & 5 \\
          \frac{1}{4} & \frac{1}{7} & 1 & \frac{1}{2} & \frac{1}{3} \\
         	\frac{1}{3} & \frac{1}{5} & 2 & 1 & 1 \\
         	\frac{1}{3} & \frac{1}{5} & 3 & 1 & 1
         }
         \right]
      $$
      稍加分析可以发现该成对比较矩阵出现了不一致的情况：由 $A2 : A1 = a_{21} = 2$ 以及 $A1 : A3 = a_{13} = 4$ 可知  $A2 : A3 = a_{23} = a_{21} \times a_{13} = 8$ ，但实际表中设置为 $A2 : A3 = a_{23} = 7$ ，此时为成对比较矩阵不一致的情况，该情况允许出现，但要确定不一致的允许范围，由第 3 步：层次单排序及一致性检验中给出。

      同理，可以给出方案层（B1 ~ B3）的所有因素针对准则层各个因素（A1 ~ A5）的成对比较矩阵示例：
      $$
      \large \qquad \qquad
      B_1 = \left[
      	\matrix{
      	1 & 2 & 5 \\
          \frac{1}{2} & 1 & 2 \\
          \frac{1}{5} & \frac{1}{2} & 1 \\
          }
          \right]
      \qquad
      B_2 = \left[
          \matrix{
          1 & \frac{1}{3} & \frac{1}{8} \\
          3 & 1 & \frac{1}{3} \\
          8 & 3 & 1 \\
          }
          \right]
      \\  \, \\ \large 
      B_3 = \left[
      	\matrix{
          1 & 1 & 3 \\
          1 & 1 & 3 \\
          \frac{1}{3} & \frac{1}{3} & 1 \\
          }
          \right]
      \qquad
      B_4 = \left[
          \matrix{
          1 & 3 & 4 \\
          \frac{1}{3} & 1 & 1 \\
          \frac{1}{4} & 1 & 1 \\
               }
          \right]
      \qquad
      B_5 = \left[
      	\matrix{
          1 & 1 & \frac{1}{4} \\
          1 & 1 & \frac{1}{4} \\
          4 & 4 & 1 \\
          }
          \right]
      \small
      $$

### 三、层次单排序及其一致性检验：

1. 对应于判断矩阵最大特征根 $\lambda$ 的特征向量，经归一化后记为 $w$ ，该向量表示同一层因素对于上一层某个因素相对重要性的排序权值，这一过程称为层次单排序。由之前的六个成对比较矩阵，可计算出六个权重及对应特征值：

   - A1 ~ A5 对 Z 的权重及特征值：$w_A = [\matrix{0.2636 & 0.4758 & 0.0538 & 0.0981 & 0.1087}],\; \lambda_A = 5.0721$ 。

   - B1, B2, B3 对 A1 的权重及特征值：$w_{B_1} = [\matrix{0.5954 & 0.2764 & 0.1283}], \; \lambda_{B_1} = 3.0055$ 。
   - B1, B2, B3 对 A2 的权重及特征值：$w_{B_2}=[\matrix{0.0819 & 0.2363 & 0.6817}], \; \lambda_{B_2} = 3.0015$ 。
   - B1, B2, B3 对 A3 的权重及特征值：$w_{B_3} = [\matrix{0.4286 & 0.4286 & 0.1429}], \; \lambda_{B_3} = 3.0000$ 。
   - B1, B2, B3 对 A4 的权重及特征值：$w_{B_4} = [\matrix{0.6337 & 0.1919 & 0.1744}], \; \lambda_{B_4} = 3.0092$ 。
   - B1, B2, B3 对 A5 的权重及特征值：$w_{B_5} = [\matrix{0.1667 & 0.1667 & 0.6667}], \; \lambda_{B_5} = 3.0000$ 。


2. 由于矩阵会出现不一致的情况，在确认层次单排序后还需进行一致性检验，即对矩阵确定不一致的允许范围。

   - 定理：$n$ 阶一致阵的唯一非零特征根为 $n$ 。
   - 定理：$n$ 阶正互反阵 $M$ 的最大特征根 $\lambda \ge n$ ，当且仅当 $\lambda = n$ 时 $M$ 为一致阵。

   由于 $\lambda$ 连续的依赖于 $a_{ij}$ ，则 $\lambda$ 比 $n$ 大的越多，$M$ 的不一致性越严重，用最大特征值对应的特征向量作为被比较因素对上层某因素影响程度的权向量，其不一致程度越大，引起的判断误差越大。因而可以用 $\lambda - n$ 数值的大小来衡量 $M$ 的不一致程度，定义一致性指标 $\displaystyle CI = \frac{\lambda - n}{n - 1}$ ，那么有：

   - 当 $CI = 0$ 则有完全一致性；
   - 当 $CI$ 接近于 0 ，有满意的一致性；
   - 当 $CI$ 越大，不一致越严重。

   为衡量 $CI$ 的大小，引入随机一致性指标 $RI$ ：

   |       n        |  1   |  2   |  3   |  4   |  5   |  6   |  7   |  8   |  9   |  10  |  11  |  12  | 13   | 14   | 15   |
   | :------------: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | ---- | ---- | ---- |
   | $\bold {RI_n}$ | 0.00 | 0.00 | 0.52 | 0.89 | 1.12 | 1.26 | 1.36 | 1.41 | 1.46 | 1.49 | 1.52 | 1.54 | 1.56 | 1.58 | 1.59 |

   定义一致性比率：$\displaystyle CR = \frac{CI}{RI}$ ，一般认为 $CR < 0.1$ 时，矩阵 $A$ 的不一致程度在容许范围内，即通过一致性检验。若不在容许范围内，则需要重新构造成对比较矩阵 $M$ ，然后再进行一致性检验。由前面求得的特征值，对案例中的六个矩阵进行一致性检验：
   $$
   \begin{split}
   CR_A &= \frac{CI_A}{RI_A} = \frac{\frac{(5.0721 - 5)}{(5 - 1)}}{RI_5} = \frac{0.018025}{1.12} = 0.0161 < 0.1 \\
   CR_{B_1} &=  \frac{CI_{B_1}}{RI_{B_1}} = \frac{\frac{3.0055 - 3}{3 - 1}}{RI_3} = \frac{0.00275}{0.52} = 0.0053 < 0.1 \\
   CR_{B_2} &=  \frac{CI_{B_2}}{RI_{B_2}} = \frac{\frac{3.0015 - 3}{3 - 1}}{RI_3} = \frac{0.00075}{0.52} = 0.0014 < 0.1 \\
   CR_{B_3} &=  \frac{CI_{B_3}}{RI_{B_3}} = \frac{\frac{3.0000 - 3}{3 - 1}}{RI_3} = \frac{0.00}{0.52} = 0.0 < 0.1 \\
   CR_{B_4} &=  \frac{CI_{B_4}}{RI_{B_4}} = \frac{\frac{3.0092 - 3}{3 - 1}}{RI_3} = \frac{0.0046}{0.52} = 0.0088 < 0.1 \\
   CR_{B_5} &=  \frac{CI_{B_5}}{RI_{B_5}} = \frac{\frac{3.0000 - 3}{3 - 1}}{RI_3} = \frac{0.00}{0.52} = 0.0 < 0.1 \\
   \end{split}
   $$


### 四、层次总排序及其一致性检验：

1. 计算某一层次所有因素对于最高层（总目标）相对重要性的权值，称为层次总排序。根据权重的传导性，可以得到 B1, B2, B3 对 Z 的权重：
   $$
   \begin{split}
   w_B &= w_A \times \left[ \matrix{w_{B_1} \\ w_{B_2} \\ w_{B_3} \\ w_{B_4} \\ w_{B_5}} \right]\\
   &= \left[ \matrix{0.2636 & 0.4758 & 0.0538 & 0.0981 & 0.1087} \right] \times \left[ \matrix{0.5954 & 0.2764 & 0.1283 \\ 0.0819 & 0.2363 & 0.6817 \\ 0.4286 & 0.4286 & 0.1429 \\ 0.6337 & 0.1919 & 0.1744 \\ 0.1667 & 0.1667 & 0.6667} \right] \\
   &= \left[ \matrix{0.2993 & 0.2453 & 0.4554} \right]
   \end{split}
   $$

2. 同样，这里也需要进行一致性检验。设本层所有因素对上层某个因素 $Mj=1,2,\cdots,k$ 的层次单排序一致性指标为 $CI_j$ ，随机一致性指标为 $RI_j$ ，且权重 $w_M = [w_1, w_2, \cdots, w_k]$ 那么层次总排序的一致性比率为：
   $$
   CR = \frac{w_1CI_1 + w_2CI_2 + \cdots + w_kCI_k}{w_1RI_1 + w_2RI_2 + \cdots + w_kRI_k}
   $$
   根据该公式对方案层（B1, B2, B3）总排序进行一致性检验：
   $$
   \begin{split}
   CR_B &= \frac{w_A^1CI_1 + \cdots + w_A^5CI_5}{w_A^1RI_1 + \cdots + w_A^5RI_5} \\ \\
   &= \frac{0.2636 \times 0.00275 + 0.4758 \times 0.00075 + 0.0538 \times 0.0 + 0.0981 \times 0.0046 + 0.1087 \times 0.0}{0.2636 \times 0.52 + 0.4758 \times 0.52 + 0.0538 \times 0.52 + 0.0981 \times 0.52 + 0.1087 \times 0.52} \\ \\
   &= \frac{0.00153301}{0.52} = 0.0029 < 0.1
   \end{split}
   $$
   由于所有的一致性检验全部通过，故方案层（B1, B2, B3）对目标层（Z）的权重结果 $\left[ \matrix{0.2993 & 0.2453 & 0.4554} \right]$ 是可以接受，再由权重结果关系 $0.4554 > 0.2993 > 0.2453$ 可知方案关系为 B3 > B1 > B2，即可得出最终决策为：桂林（B3）。

以上案例的 python 实现代码可参考目录 `code` 下的源代码 `AHP.PY` 。

*参考资料：[百度文库：层次分析法如何确定权重][1]*

[1]: https://wenku.baidu.com/view/c9f29fc06f1aff00bed51ef9#